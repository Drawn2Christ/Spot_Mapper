<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Spot-Mapper</title>

  <!-- Icons (optional, falls du sie schon hochgeladen hast) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Spot-Map">

  <!-- Leaflet (OSM Karte) - jsDelivr (seltener geblockt als unpkg) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; }
    /* iOS/Standalone friendly */
    #map { height: 55vh; min-height: 340px; width: 100vw; background: #f2f2f2; }

    .panel { padding: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    button { padding: 10px 12px; border: 1px solid #ccc; background: #fff; border-radius: 10px; }
    button.primary { border-color: #111; }
    button.danger { border-color:#b00; color:#b00; }
    input, select { padding: 10px; border: 1px solid #ccc; border-radius: 10px; flex: 1; min-width: 150px; }

    .small { font-size: 12px; color: #444; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 10px; margin: 8px 0; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }

    .compassWrap { display:flex; gap: 12px; align-items:center; margin-top: 10px; }
    .compass {
      width: 84px; height: 84px; border-radius: 50%;
      border: 2px solid #111; position: relative; flex: 0 0 auto;
    }
    .needle {
      position:absolute; left:50%; top:50%;
      width: 2px; height: 34px; background:#111;
      transform-origin: 50% 100%;
      transform: translate(-50%,-100%) rotate(0deg);
    }
    .needle::after{
      content:""; position:absolute; top:-10px; left:-6px;
      width: 0; height: 0; border-left: 7px solid transparent;
      border-right: 7px solid transparent; border-bottom: 10px solid #111;
    }

    hr { border: none; border-top: 1px solid #eee; margin: 12px 0; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <!-- See -->
    <div class="row">
      <input id="lakeName" placeholder="See / Gew√§sser (z.B. Amb√ºhrener See)" />
      <button id="btnLoad" class="primary">See laden</button>
      <button id="btnSetSwimFromGPS">üìç Swim setzen</button>
    </div>

    <!-- Multi Swims -->
    <div class="row">
      <select id="swimSelect"></select>
      <button id="btnNewSwim">‚ûï Neuer Swim</button>
      <button id="btnRenameSwim">‚úèÔ∏è Swim umbenennen</button>
      <button id="btnDeleteSwim" class="danger">üóë Swim l√∂schen</button>
    </div>

    <!-- Actions -->
    <div class="row">
      <button id="btnCompass" class="primary">üß≠ Kompass aktivieren</button>
      <button id="btnAddSpot">‚ûï Spot speichern</button>
      <button id="btnRedraw">üßπ Marker neu zeichnen</button>
    </div>

    <!-- Info -->
    <div class="small">
      <div>Aktiver Swim: <span id="swimNameInfo" class="mono">‚Äì</span></div>
      <div>Swim Koordinate: <span id="swimInfo" class="mono">nicht gesetzt</span></div>
      <div>Heading: <span id="headingInfo" class="mono">‚Äì</span></div>
      <div>Ausgew√§hlter Spot: <span id="targetInfo" class="mono">‚Äì</span></div>
      <div>Wraps (3,60m): <span id="wrapInfo" class="mono">‚Äì</span></div>
    </div>

    <div class="compassWrap">
      <div class="compass" aria-label="Kompass">
        <div id="needle" class="needle"></div>
      </div>
      <div>
        <div class="small" style="font-weight:600;" id="compassStatus">Kompass aus</div>
        <div class="small">Der Pfeil zeigt zum ausgew√§hlten Spot (wenn einer ausgew√§hlt ist).</div>
      </div>
    </div>

    <hr>

    <!-- Export/Import -->
    <div class="row">
      <button id="btnExport">‚¨áÔ∏è Export JSON</button>
      <button id="btnImport">‚¨ÜÔ∏è Import JSON</button>
      <button id="btnDeleteLake" class="danger">üóë See l√∂schen</button>
    </div>

    <!-- Spots -->
    <div id="spotList"></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---------- Helpers ----------
  const toRad = (deg) => deg * Math.PI / 180;
  const toDeg = (rad) => rad * 180 / Math.PI;
  const clamp360 = (deg) => (deg % 360 + 360) % 360;

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  // destination point from start, bearing, distance
  function destinationPoint(start, bearing, distMeters) {
    const R = 6371000;
    const brng = toRad(bearing);
    const lat1 = toRad(start.lat), lng1 = toRad(start.lng);
    const dr = distMeters / R;

    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dr) + Math.cos(lat1)*Math.sin(dr)*Math.cos(brng));
    const lng2 = lng1 + Math.atan2(
      Math.sin(brng)*Math.sin(dr)*Ma
